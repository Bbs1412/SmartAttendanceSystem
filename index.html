<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Attendance System</title>
    <link rel="icon" href="/assets/infinity.ico" type="image/x-icon">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f4f4f9;
            color: #333;
        }

        /* Main Container */
        #main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 2rem;
            box-shadow: 0px 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            background-image: url('/assets/image.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Title */
        h1 {
            font-size: 2.5rem;
            color: #2b2b2b;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: bold;
        }

        /* Form Styles */
        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }

        label {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 1rem;
        }

        video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 1.5rem;
        }

        /* Button Styles */
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 0.5rem;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #b3b3b3;
            cursor: not-allowed;
        }

        /* Error Box */
        #errBox {
            display: none;
            /* Initially hidden */
            flex-direction: column;
            /* Stack items vertically when displayed */
            align-items: center;
            /* Center horizontally */
            justify-content: center;
            /* Center vertically */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40%;
            height: auto;
            background-color: #2b2b2b;
            color: white;
            border-radius: 1.5rem;
            text-align: center;
            z-index: 999;
            box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* Upload Status and Attendance Div */
        #upload_status {

            font-size: 1.2rem;
            color: #4BB543;
        }

        #attendance_div {
            display: flex;
            flex-direction: column;
            /* Stack items vertically */
            align-items: center;
            gap: 1rem;
            /* Adds spacing between stacked elements */
            margin-top: 2rem;
        }

        #attendance_div img {
            width: 200px;
            height: 200px;

        }

        #calc_attend {
            color: #ddd;
            font-size: 1.2rem;
        }

        #extracting_wait {
            color: #007BFF;
            font-size: 1.2rem;
            margin-top: 1rem;
            text-align: center;
        }

        /* Loader Styles */
        #loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            height: 150px;
            /* Increased size */
            width: 150px;
            /* Increased size */
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        #loader img {
            width: 150px;
            /* Increased size */
            height: 150px;
            /* Increased size */
        }

        .video-container {
            position: relative;
            width: 100%;

        }

        #placeholderImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            border-radius: 15px;

        }

        #upload_status,
        #load,
        #calc_attend {
            flex: 1;
            /* Make each item take up equal space */
            text-align: center;
            /* Center the text inside each column */
            padding: 20px;
        }

        #load {
            height: 100px;
            width: 100px;
        }
    </style>

</head>

<body>
    <div id="main">
        <h1>Video Attendance System</h1>
        <form id="uploadForm" action="/upload_video" method="post" enctype="multipart/form-data">
            <div>
                <div class="video-container">
                    <video id="video" autoplay></video>
                    <img id="placeholderImage" src="/assets/camera.png" alt="Placeholder Image">
                </div>
                <button type="button" id="startCamera">Start Camera</button>
                <button type="button" id="startRecord" disabled>Start Recording</button>
                <button type="button" id="stopRecord" disabled>Stop Recording</button>
            </div>

            <!-- Hidden input for video data -->
            <input type="hidden" name="video_data" id="videoData">
            <input type="hidden" name="timestamps" id="timestamps">
            <br><br>

            <span id="extracting_wait" style="display: none;">Extracting frames, please wait...</span>
            <input type="submit" value="Upload Video" disabled>
        </form>
    </div>

    <div id="errBox">
        <h1 id="proc_stat">Processing video, please wait...</h1>
        <h2 id="upload_status"></h2>
        <div id="attendance_div">
            <img id="load" src="/assets/loading_5.gif" alt="Loading">
            <h2 id="calc_attend">Checking Attendance...</h2>
        </div>
    </div>

    <!-- Loader Element -->
    <div id="loader">
        <img src="/assets/loading_5.gif" alt="Loading">
    </div>

    <script>
        let mediaRecorder;
        let recordedBlobs;
        let stream;

        let startTimestamp;
        let endTimestamp;

        let temp;
        // let no_of_frames_to_send = 100;
        let no_of_frames_to_send = 20;


        const video = document.querySelector('video');
        const cameraButton = document.getElementById('startCamera');
        const startButton = document.getElementById('startRecord');
        const stopButton = document.getElementById('stopRecord');
        const submitButton = document.querySelector('input[type="submit"]');

        const mn = document.getElementById('main');
        const err_box = document.getElementById('errBox');

        startButton.disabled = true;
        cameraButton.addEventListener('click', () => {
            init({ video: true });
            startButton.disabled = false;
            // Hide the placeholder and show the video
            document.getElementById('placeholderImage').style.display = 'none';
            document.getElementById('video').style.display = 'block';
        });

        startButton.addEventListener('click', () => {
            // startTimestamp = new Date().toISOString(); // Capture start timestamp
            startTimestamp = new Date();
            startRecording();
            startButton.disabled = true;
            stopButton.disabled = false;
            submitButton.disabled = true;
        });

        stopButton.addEventListener('click', () => {
            endTimestamp = new Date();
            stopRecording();
            startButton.disabled = true;
            stopButton.disabled = true;
            // submitButton.disabled = false; // let this be handled by frame extractor function
            document.getElementById("extracting_wait").style.display = 'flex';
            releaseCamera();
        });

        submitButton.addEventListener('click', (e) => {
            e.preventDefault();
            submitForm();
        });

        async function init(constraints) {
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                handleSuccess(stream);
            } catch (e) {
                console.error('navigator.getUserMedia error:', e);
            }
        }

        function handleSuccess(stream) {
            video.srcObject = stream;
        }

        function startRecording() {
            console.log('JS: Recording started')
            recordedBlobs = [];
            let options = { mimeType: 'video/webm;codecs=vp9' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options = { mimeType: 'video/webm;codecs=vp8' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'video/webm' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options = { mimeType: '' };
                    }
                }
            }

            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                console.error('Exception while creating MediaRecorder:', e);
                return;
            }

            mediaRecorder.onstop = (event) => {
                const superBuffer = new Blob(recordedBlobs, { type: 'video/webm' });
                extractFrames(superBuffer, no_of_frames_to_send);
            };

            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.start(10);
        }

        function stopRecording() {
            console.log('JS: Recording stopped')
            mediaRecorder.stop();
        }

        function handleDataAvailable(event) {
            if (event.data && event.data.size > 0) {
                recordedBlobs.push(event.data);
            }
        }

        function releaseCamera() {
            console.log('JS: Released Camera')
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
        }



        async function extractFrames(videoBlob, no_of_frames_to_send) {
            const debug = true;

            console.log('JS: Extract frames activated');
            const videoElement = document.createElement('video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            videoElement.src = URL.createObjectURL(videoBlob);

            if (debug) { console.log('JS: [1/n] Video context received'); }
            await new Promise(resolve => {
                videoElement.onloadedmetadata = () => {
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    resolve();
                };
            });

            const totalDuration = (endTimestamp - startTimestamp) / 1000; // Total duration in seconds
            const interval = totalDuration / no_of_frames_to_send; // Gap between frames in seconds
            let frames = [];
            let timestamps = [];
            if (debug) { console.log('JS: [2/n] Video interval to extract', interval); }

            for (let i = 0; i < no_of_frames_to_send; i++) {
                const desiredTime = i * interval;
                videoElement.currentTime = desiredTime;

                await new Promise(resolve => {
                    videoElement.onseeked = () => {
                        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        frames.push(canvas.toDataURL('image/jpeg'));

                        // Calculate the timestamp for this frame
                        let frameTimestamp = new Date(startTimestamp.getTime() + desiredTime * 1000);
                        timestamps.push(frameTimestamp.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' }));

                        if (debug) { console.log(`JS: [Frame ${i + 1}] Captured at time ${desiredTime}`); }

                        resolve();
                    };
                });
            }

            if (debug) { console.log('JS: [3a/n] Intermediate: Frames: ', frames.length); }
            if (debug) { console.log('JS: [3b/n] Intermediate: Timestamps: ', timestamps.length); }

            if (frames.length < no_of_frames_to_send) {
                for (let i = frames.length; i < no_of_frames_to_send; i++) {
                    frames.push(frames[frames.length - 1]);
                    timestamps.push(timestamps[timestamps.length - 1]);
                }
            }

            if (debug) { console.log('JS: [4a/n] Final: Frames: ', frames.length); }
            if (debug) { console.log('JS: [4b/n] Final: Timestamps: ', timestamps.length); }

            document.getElementById('videoData').value = JSON.stringify(frames);
            document.getElementById('timestamps').value = JSON.stringify(timestamps);

            if (debug) { console.log('JS: [n/n] Form data updated'); }

            // Enable submit button
            document.getElementById('extracting_wait').style.display = 'none';
            submitButton.disabled = false;
        }

        // ------------------------------------------------------


        // submit these: num_students, student_names, video_data, timestamps
        // vid data is no_of_frames_to_send images in base64
        function submitForm() {
            console.log('JS: Submit form activated')
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);

            // debug
            temp = formData;

            mn.style.cssText = 'filter: blur(2px)';
            err_box.style.display = 'flex';
            document.getElementById('proc_stat').style.display = 'flex';


            fetch('/upload_video', {
                method: 'POST',
                body: formData
            }).then(response => response.json())
                .then(data => {
                    console.log(data);

                    if (data.status === 'success') {
                        // console.log("Vid Sent Successfully");
                        document.getElementById('upload_status').innerHTML = "<p>âœ… Video Sent Successfully!<p>";
                        document.getElementById('attendance_div').style.display = 'flex';
                        document.getElementById('proc_stat').style.display = 'flex';

                        calculate_attendance();
                    }

                });
        }

        function calculate_attendance() {
            console.log('JS: Started attendance calculation on server!')

            fetch('/calc_attendance', {
                method: 'GET',
            }).then(response => response.json())
                .then(data => {
                    console.log("Attendance status: ", data);

                    if (data.status === 'completed') {
                        console.log('JS: Attendance calculation Completed!')
                        console.log('JS: Getting results from server!')
                        window.location.href = '/results';
                    }

                    else {
                        window.alert("Sorry, some error occurred on server side!")
                    }
                })
        }

    </script>
</body>

</html>